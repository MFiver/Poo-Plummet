<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poo Plummet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen max-h-screen">
  <div class="text-center">
    <div class="bg-amber-900 text-white text-4xl font-bold py-2">POO PLUMMET</div>
    <p class="my-1">Use left/right arrow keys to guide the poo into the toilet!</p>
    <p id="level" class="my-1">Level: 1</p>
    <p id="highScore" class="my-1">High Score: None</p>
    <div id="gameCanvas" class="mt-2" style="border: none;"></div>
    <p id="feedback" class="mt-2 text-lg"></p>
    <button id="restartButton" onclick="restartGame()" class="mt-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 hidden">Play Again</button>
  </div>

  <script>
    let pooX, pooY, pooSpeed, windForce;
    let toiletX, toiletWidth;
    let gameOver = false;
    let level = 1;
    let highScore = { name: "None", score: 0 };
    let showHighScoreAnimation = false;
    let animationTimer = 0;
    let particles = [];
    let userInteracted = false;
    const fartSound = new Audio('https://cdn.pixabay.com/audio/2023/03/29/12-24-24-614_1.mp3'); // Public domain fart sound
    const splashSound = new Audio('https://cdn.pixabay.com/audio/2022/08/02/14-21-45-597_1.mp3'); // Public domain splash sound
    const flushSound = new Audio('https://cdn.pixabay.com/audio/2023/03/20/13-55-53-254_1.mp3'); // Public domain toilet flush

    function preload() {
      try {
        fartSound.load();
        splashSound.load();
        console.log('Audio files preloaded');
      } catch (e) {
        console.error('Audio preload failed:', e);
      }
    }

    function setup() {
      try {
        let canvas = createCanvas(400, 500);
        canvas.parent('gameCanvas');
        loadHighScore();
        resetLevel();
        // Enable audio on first interaction
        function unlockAudio() {
  userInteracted = true;
  fartSound.load();
  splashSound.load();
  flushSound.load();
  fartSound.play().catch(() => {});
  splashSound.play().catch(() => {});
  flushSound.play().catch(() => {});
  fartSound.pause();
  splashSound.pause();
  flushSound.pause();
  fartSound.currentTime = 0;
  splashSound.currentTime = 0;
  flushSound.currentTime = 0;
  console.log('Audio unlocked by user');
}
document.addEventListener('keydown', unlockAudio, { once: true });
        document.addEventListener('click', unlockAudio, { once: true });
        console.log('Game setup completed');
      } catch (e) {
        console.error('Setup failed:', e);
      }
    }

    function loadHighScore() {
      try {
        const saved = localStorage.getItem('pooPlummetHighScore');
        if (saved) {
          highScore = JSON.parse(saved);
          console.log('Loaded high score:', highScore);
        } else {
          console.log('No high score found in localStorage');
        }
        updateHighScoreDisplay();
      } catch (e) {
        console.error('Load high score failed:', e);
      }
    }

    function saveHighScore() {
      try {
        localStorage.setItem('pooPlummetHighScore', JSON.stringify(highScore));
        console.log('Saved high score:', highScore);
        updateHighScoreDisplay();
      } catch (e) {
        console.error('Save high score failed:', e);
      }
    }

    function updateHighScoreDisplay() {
      document.getElementById('highScore').textContent = `High Score: ${highScore.name} - Level ${highScore.score}`;
    }

    function resetLevel() {
      pooX = width / 2;
      pooY = 50;
      pooSpeed = 2;
      windForce = 0;
      toiletX = random(50, width - 50);
      toiletWidth = 45;
      gameOver = false;
      showHighScoreAnimation = false;
      animationTimer = 0;
      particles = [];
      document.getElementById('feedback').textContent = '';
      document.getElementById('restartButton').classList.add('hidden');
      document.getElementById('level').textContent = `Level: ${level}`;
      if (userInteracted) {
        fartSound.play().catch(e => console.error('Fart sound failed:', e));
      }
      console.log('Level reset:', level);
    }

    function restartGame() {
  if (userInteracted) {
    flushSound.play().catch(e => console.error('Flush sound failed:', e));
  }
      level = 1;
      resetLevel();
      console.log('Game restarted');
    }

    function draw() {
      try {
        background(0);
        noStroke();

        if (!gameOver) {
          let windRange = 1.5 + (level - 1) * 0.75;
          windForce = random(-windRange, windRange);
          pooX += windForce;
          if (keyIsDown(LEFT_ARROW)) pooX -= 2;
          if (keyIsDown(RIGHT_ARROW)) pooX += 2;
          pooY += pooSpeed;
          pooX = constrain(pooX, 0, width);

          if (pooY >= height - 45) {
            gameOver = true;
            let feedback = document.getElementById('feedback');
            if (pooX >= toiletX - toiletWidth / 2 && pooX <= toiletX + toiletWidth / 2) {
              feedback.textContent = `Success! On to Level ${level + 1}!`;
              feedback.classList.add('text-green-600');
              if (userInteracted) {
                splashSound.play().catch(e => console.error('Splash sound failed:', e));
              }
              level++;
              resetLevel();
            } else {
              feedback.textContent = `Missed! Game Over at Level ${level}.`;
              feedback.classList.add('text-red-600');
              console.log('Checking high score: current level', level, 'vs high score', highScore.score);
              if (level - 1 > highScore.score) {
                let name = window.prompt('New High Score! Enter your name:', 'Player');
                console.log('Prompt result:', name);
                if (name !== null) {
                  highScore = { name: name.trim() || 'Anonymous', score: level - 1 };
                  saveHighScore();
                  showHighScoreAnimation = true;
                  createParticles();
                }
              }
              document.getElementById('restartButton').classList.remove('hidden');
            }
          }
        }

        if (showHighScoreAnimation) {
          animationTimer++;
          let scale = 1 + 0.5 * sin(animationTimer * 0.1);
          textAlign(CENTER);
          textSize(36 * scale);
          textStyle(BOLD);
          fill(random(255), random(255), random(255));
          text("NICE TURD!", width / 2, height / 2 - 20);
          text("NEW HIGH SCORE!", width / 2, height / 2 + 20);
          for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.y += p.speed;
            fill(p.r, p.g, p.b, p.alpha);
            ellipse(p.x, p.y, 5, 5);
            p.alpha -= 5;
            if (p.alpha <= 0) particles.splice(i, 1);
          }
          if (animationTimer > 120) showHighScoreAnimation = false;
        }

        let tileSize = 10;
        for (let x = 0; x < width; x += tileSize) {
          for (let y = height - 20; y < height; y += tileSize) {
            fill((x / tileSize + y / tileSize) % 2 === 0 ? 255 : 0);
            rect(x, y, tileSize, tileSize);
          }
        }

        fill(255);
        rect(toiletX - 30, height - 120, 60, 60);
        arc(toiletX, height - 60, 60, 45, PI, 0);
        arc(toiletX, height - 60, 60, 45, 0, PI);
        stroke(200);
        strokeWeight(3);
        noFill();
        arc(toiletX, height - 60, 66, 51, PI, 0);
        noStroke();
        fill(0, 191, 255);
        ellipse(toiletX, height - 60, 45, 22.5);

        fill(139, 69, 19);
        beginShape();
        vertex(pooX - 7.5, pooY - 15);
        vertex(pooX + 7.5, pooY - 12);
        vertex(pooX + 10.5, pooY);
        vertex(pooX + 7.5, pooY + 12);
        vertex(pooX - 7.5, pooY + 15);
        vertex(pooX - 10.5, pooY + 3);
        endShape(CLOSE);

        fill(255, 218, 185);
        arc(width / 2 - 40, 0, 80, 80, 0, PI);
        arc(width / 2 + 40, 0, 80, 80, 0, PI);
        noStroke();

        fill(255);
        textAlign(CENTER);
        textSize(14);
        text(`Fart Wind: ${windForce.toFixed(2)}`, width / 2, 80);
      } catch (e) {
        console.error('Draw failed:', e);
      }
    }

    function createParticles() {
      for (let i = 0; i < 20; i++) {
        particles.push({
          x: random(width),
          y: random(height),
          speed: random(1, 3),
          r: random(255),
          g: random(255),
          b: random(255),
          alpha: 255
        });
      }
    }
  </script>
</body>
</html>